# 🔍 代理连接预检功能说明

## 📋 功能概述

代理连接预检功能会在程序启动时自动检测代理是否可用，避免在抓取过程中浪费大量时间。

## ✨ 主要特性

1. **自动检测** - 程序启动时自动检测代理连接
2. **快速失败** - 代理不可用时立即退出，给出明确提示
3. **友好提示** - 提供详细的错误原因和解决方案
4. **兼容旧版** - 支持新旧两种配置格式

## 🎯 工作原理

### 检测流程

```
启动程序
    ↓
加载配置文件
    ↓
检查是否启用代理?
    ├── 否 → 继续执行（直接连接）
    └── 是 ↓
         测试代理端口连接
              ├── 成功 → 继续执行
              └── 失败 → 显示错误提示 → 退出程序
```

### 检测方法

使用 Python 的 `socket` 模块测试代理端口是否可连接：

```python
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.settimeout(timeout)
result = sock.connect_ex((host, port))
```

## 📝 使用方法

### 方法一：运行主程序（自动检测）

```bash
# 直接运行，会自动进行代理预检
python core/core.py
```

或者通过 GUI 运行：

```bash
python gui/gui.py
```

### 方法二：使用独立测试工具

```bash
# 单独测试代理连接
python test_proxy.py
```

## 🔧 配置示例

### 新版配置格式（推荐）

```yaml
network:
  proxy:
    enabled: true           # 是否启用代理
    type: "socks5"         # 代理类型: http / https / socks5
    host: "127.0.0.1"      # 代理主机
    port: "10808"          # 代理端口
    http: "socks5://127.0.0.1:10808"    # HTTP 代理 URL
    https: "socks5://127.0.0.1:10808"   # HTTPS 代理 URL
```

### 旧版配置格式（兼容）

```yaml
proxy:
  enabled: true
  http: "http://127.0.0.1:10808"
  https: "http://127.0.0.1:10808"
```

## 📊 输出示例

### 成功示例

```
🚀 启动批量模特视频同步检查系统（模块化版本）
============================================================
配置文件: config.yaml
模特数量: 10
本地目录: ['F:\\作品']
输出目录: output
抓取工具: selenium
最大翻页: 无限制
运行模块: 自动模式
============================================================

🔍 检测到已启用代理，正在进行连接测试...
   代理类型: socks5
   代理地址: 127.0.0.1:10808
🔍 测试代理连接: 127.0.0.1:10808
✅ 代理连接测试成功: 127.0.0.1:10808
✅ 代理连接测试通过，继续执行...

[继续执行抓取任务...]
```

### 失败示例

```
🚀 启动批量模特视频同步检查系统（模块化版本）
============================================================
配置文件: config.yaml
模特数量: 10
本地目录: ['F:\\作品']
输出目录: output
抓取工具: selenium
最大翻页: 无限制
运行模块: 自动模式
============================================================

🔍 检测到已启用代理，正在进行连接测试...
   代理类型: socks5
   代理地址: 127.0.0.1:10808
🔍 测试代理连接: 127.0.0.1:10808
❌ 代理连接失败: 127.0.0.1:10808 (错误码: 10061)

============================================================
❌ 代理连接失败！
============================================================

请检查以下问题：
  1. 代理工具（如 v2rayN、Clash 等）是否已启动
  2. 代理配置是否正确（主机地址和端口）
  3. 代理工具是否已成功连接到服务器
  4. 防火墙是否阻止了代理连接

💡 解决方法：
  • 启动代理工具并确保连接成功
  • 在 config.yaml 中修改代理配置
  • 或者在 config.yaml 中设置 proxy.enabled: false 禁用代理

程序已退出，请解决代理问题后重新运行。
============================================================
```

## 🐛 常见问题

### Q1: 代理工具已启动，但仍然提示连接失败？

**原因：**
- 代理端口配置错误
- 代理工具使用了不同的监听端口

**解决方法：**
1. 检查代理工具的监听端口（通常在设置中）
2. 修改 `config.yaml` 中的 `port` 配置
3. 常见端口：
   - v2rayN: 10808 (SOCKS5) / 10809 (HTTP)
   - Clash: 7890 (HTTP) / 7891 (SOCKS5)

### Q2: 不想使用代理怎么办？

**解决方法：**

在 `config.yaml` 中设置：

```yaml
network:
  proxy:
    enabled: false    # 禁用代理
```

### Q3: 代理检测超时怎么办？

**原因：**
- 网络延迟较大
- 代理服务器响应慢

**解决方法：**

默认超时时间是 10 秒，如果需要更长时间，可以修改 `core/core.py` 中的超时参数：

```python
# 将超时时间从 10 秒改为 30 秒
if not test_proxy_connection(proxy_config, timeout=30, logger=logger):
```

### Q4: 如何跳过代理检测？

**不建议跳过**，但如果确实需要：

1. 临时禁用：在配置文件中设置 `proxy.enabled: false`
2. 修改代码：注释掉 `core/core.py` 中的代理检测代码

## 📈 性能影响

- **检测时间**: 通常 < 1 秒
- **失败时间**: 最多 10 秒（超时）
- **对比节省**: 避免了数分钟甚至数小时的无效等待

**结论**: 短暂的检测时间可以节省大量的后续时间！

## 🔐 安全性

- ✅ 仅测试端口连接，不发送任何数据
- ✅ 不会泄露任何敏感信息
- ✅ 本地 socket 连接，安全可靠

## 💡 最佳实践

1. **启动代理工具**
   - 在运行程序前先启动代理工具
   - 确保代理工具已连接到服务器

2. **验证配置**
   - 使用 `test_proxy.py` 独立测试
   - 确认端口和主机地址正确

3. **查看日志**
   - 检查日志文件获取详细信息
   - 日志位置: `output/logs/`

4. **使用 GUI**
   - GUI 中有【代理测试】标签页
   - 可以直接测试代理连接

## 🎯 优势总结

| 特性 | 说明 | 好处 |
|------|------|------|
| **快速失败** | 启动时检测 | 避免长时间无效等待 |
| **明确提示** | 详细错误信息 | 快速定位问题 |
| **友好引导** | 提供解决方案 | 新手也能轻松解决 |
| **兼容性好** | 支持多种格式 | 无需修改旧配置 |
| **零成本** | 仅需 < 1 秒 | 性能影响极小 |

## 📚 相关文档

- [安装指南](INSTALL.md) - 完整的安装和配置说明
- [优化建议](OPTIMIZATION_SUGGESTIONS.md) - 更多优化建议
- [快速启动](QUICKSTART.md) - 5 分钟快速上手

---

**创建日期**: 2026-02-09  
**版本**: v1.0  
**状态**: ✅ 已实现
